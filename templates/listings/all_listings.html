{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container">
    <!-- Header with Add Listing Button -->
    {% if user.is_authenticated %}
    <div class="listings-header">
        <a href="{% url 'add_listing' %}" class="add-listing-btn">
            <i class="fas fa-plus" style="margin-right: 8px;"></i>Add Listing
        </a>
    </div>
    {% endif %}
    
    <!-- Sorting and Filtering Section -->
    <div class="sort-filter-section">
        <h2 class="sort-title">Sort listings by...</h2>
        <div class="filter-dropdowns">
            <select class="filter-dropdown" id="price-filter" name="price" onchange="applyFilters()">
                <option value="">Price Sort</option>
                <option value="low-high" {% if selected_price == 'low-high' %}selected{% endif %}>Low to High</option>
                <option value="high-low" {% if selected_price == 'high-low' %}selected{% endif %}>High to Low</option>
            </select>
            <select class="filter-dropdown" id="price-range-filter" name="price_range" onchange="applyFilters()">
                <option value="">Price Range</option>
                {% for pricebucket in pricebuckets %}
                <option value="{{ pricebucket.pk }}" {% if selected_price_range == pricebucket.pk %}selected{% endif %}>{{ pricebucket.range }}</option>
                {% endfor %}
            </select>
            <select class="filter-dropdown" id="neighborhood-filter" name="neighborhood" onchange="applyFilters()">
                <option value="">Neighborhood</option>
                {% for neighborhood in neighborhoods %}
                <option value="{{ neighborhood.pk }}" {% if selected_neighborhood == neighborhood.pk %}selected{% endif %}>{{ neighborhood.name }}</option>
                {% endfor %}
            </select>
            <select class="filter-dropdown" id="type-filter" name="type" onchange="applyFilters()">
                <option value="">Type</option>
                {% for prop_type in property_types %}
                <option value="{{ prop_type.pk }}" {% if selected_type == prop_type.pk %}selected{% endif %}>{{ prop_type.name }}</option>
                {% endfor %}
            </select>
            {% if user.is_authenticated %}
            <select class="filter-dropdown" id="visibility-filter" name="visibility" onchange="applyFilters()">
                <option value="">Visibility</option>
                <option value="all"     {% if selected_visibility == "all" %}selected{% endif %}>All</option>
                <option value="visible" {% if selected_visibility == "visible" %}selected{% endif %}>Visible</option>
                <option value="hidden"  {% if selected_visibility == "hidden" %}selected{% endif %}>Hidden</option>
            </select>
            {% endif %}
        </div>
    </div>

    <!-- Listings Container (updated via AJAX) -->
    <div id="listings-container">
        {% include 'listings/listing_fragment.html' %}
    </div>
    
    <!-- Pagination Container (updated via AJAX) -->
    <div id="pagination-container">
        {% include 'listings/pagination_fragment.html' %}
    </div>
</div>

<div id="hide-listing-modal" class="hide-modal-overlay">
    <div class="hide-modal-card">
        <div class="hide-modal-icon">
            <i class="fas fa-exclamation"></i>
        </div>
        <p class="hide-modal-text">
            Are you sure you want to hide<br>
            this listing from site visitors?
        </p>

        <div class="hide-modal-actions">
            <button type="button" class="hide-modal-btn hide-modal-confirm">
                Yes, hide!
            </button>
            <button type="button" class="hide-modal-btn hide-modal-cancel">
                Cancel
            </button>
        </div>
    </div>
</div>
<form id="hide-listing-form" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="visibility" id="hide-listing-visibility" value="hide">
    <input type="hidden" name="next" id="hide-listing-next-url" value="">
</form>


<script>
// Apply filters using AJAX (no page reload)
function applyFilters() {
    const priceFilter = document.getElementById('price-filter');
    const priceRangeFilter = document.getElementById('price-range-filter');
    const neighborhoodFilter = document.getElementById('neighborhood-filter');
    const typeFilter = document.getElementById('type-filter');
    const visibilityFilter = document.getElementById('visibility-filter');

    const params = new URLSearchParams();
    
    // Build query parameters
    if (priceFilter.value) {
        params.append('price', priceFilter.value);
    }
    if (priceRangeFilter.value) {
        params.append('price_range', priceRangeFilter.value);
    }
    if (neighborhoodFilter.value) {
        params.append('neighborhood', neighborhoodFilter.value);
    }
    if (typeFilter.value) {
        params.append('type', typeFilter.value);
    }

    if (visibilityFilter && visibilityFilter.value) {
        params.append('visibility', visibilityFilter.value);
    }
    
    // Update URL without reloading page (without ajax parameter)
    const queryString = params.toString();
    const displayUrl = '{% url "listings" %}' + (queryString ? '?' + queryString : '');
    window.history.pushState({}, '', displayUrl);
    
    // Add AJAX parameter for fetch request only
    params.append('ajax', '1');
    const paramString = params.toString();
    const baseUrl = '{% url "listings" %}';
    const fetchUrl = baseUrl + (paramString ? '?' + paramString : '');
    
    // Debug: log the fetch URL
    console.log('Base URL:', baseUrl);
    console.log('Parameters:', paramString);
    console.log('Full Fetch URL:', fetchUrl);
    console.log('AJAX parameter present:', paramString.includes('ajax=1'));
    
    // Show loading state
    const listingsContainer = document.getElementById('listings-container');
    const paginationContainer = document.getElementById('pagination-container');
    listingsContainer.innerHTML = '<div class="no-listings"><p>Loading...</p></div>';
    paginationContainer.innerHTML = '';
    
    // Fetch filtered results via AJAX
    fetch(fetchUrl, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            // If not JSON, try to get text to see what we got
            return response.text().then(text => {
                console.error('Expected JSON but got:', contentType, text.substring(0, 200));
                throw new Error('Server returned HTML instead of JSON. Check if AJAX detection is working.');
            });
        }
        return response.json();
    })
    .then(data => {
        // Check for error in response
        if (data.error) {
            console.error('Server error:', data.error);
            listingsContainer.innerHTML = '<div class="no-listings"><p>Error loading listings. Please refresh the page.</p></div>';
            return;
        }
        
        // Update listings container
        listingsContainer.innerHTML = data.listings_html;
        
        // Update pagination container (links will use normal navigation)
        paginationContainer.innerHTML = data.pagination_html;
        
        // Scroll to top of listings
        listingsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    })
    .catch(error => {
        console.error('Error fetching listings:', error);
        listingsContainer.innerHTML = '<div class="no-listings"><p>Error loading listings. Please refresh the page.</p></div>';
    });
}

// Note: Pagination links use normal navigation (full page load) to keep behavior simple.
document.addEventListener('DOMContentLoaded', function () {
    const modal          = document.getElementById('hide-listing-modal');
    const confirmBtn     = modal.querySelector('.hide-modal-confirm');
    const cancelBtn      = modal.querySelector('.hide-modal-cancel');
    const form           = document.getElementById('hide-listing-form');
    const visibilityInput= document.getElementById('hide-listing-visibility');
    const textEl         = modal.querySelector('.hide-modal-text');

    let currentToggleUrl = null;

    function openModal(action, url) {
        currentToggleUrl = url || null;
        visibilityInput.value = action === 'show' ? 'show' : 'hide';

        if (action === 'show') {
            textEl.innerHTML = 'Are you sure you want to show<br>this listing to site visitors?';
            confirmBtn.textContent = 'Yes, show!';
        } else {
            textEl.innerHTML = 'Are you sure you want to hide<br>this listing from site visitors?';
            confirmBtn.textContent = 'Yes, hide!';
        }

        modal.classList.add('show');
    }

    function closeModal() {
        modal.classList.remove('show');
        currentToggleUrl = null;
    }

    // ðŸ”¹ Single document-level click handler (works with AJAX-loaded content)
    document.addEventListener('click', function (event) {
        const toggleBtn      = event.target.closest('.listing-actions-toggle');
        const visibilityBtn  = event.target.closest('.visibility-toggle-btn');
        const actionsMenu    = event.target.closest('.listing-actions-menu');
        const actionsWrapper = event.target.closest('.listing-actions');

        // 1) Three dots clicked â†’ toggle that menu, close others
        if (toggleBtn) {
            event.stopPropagation();
            const wrapper = toggleBtn.closest('.listing-actions');
            const isOpen  = wrapper.classList.contains('open');

            document.querySelectorAll('.listing-actions.open')
                .forEach(el => el.classList.remove('open'));

            if (!isOpen) {
                wrapper.classList.add('open');
            }
            return;
        }

        // 2) Visibility action clicked ("Hide Listing" or "Show Listing")
        if (visibilityBtn) {
            event.stopPropagation();

            const url    = visibilityBtn.dataset.toggleUrl || null;
            const action = visibilityBtn.dataset.visibilityAction || 'hide';

            // Close the menu
            const wrapper = visibilityBtn.closest('.listing-actions');
            if (wrapper) {
                wrapper.classList.remove('open');
            }

            openModal(action, url);
            return;
        }

        // 3) Click inside menu should NOT close it
        if (actionsMenu) {
            return;
        }

        // 4) Click anywhere else â†’ close any open menus
        document.querySelectorAll('.listing-actions.open')
            .forEach(el => el.classList.remove('open'));
    });

    // Modal: click outside the card closes it
    modal.addEventListener('click', function () {
        closeModal();
    });

    // Modal: click inside the card should NOT close it
    modal.querySelector('.hide-modal-card').addEventListener('click', function (event) {
        event.stopPropagation();
    });

    // Confirm button: submit the hidden form
    confirmBtn.addEventListener('click', function (event) {
        event.stopPropagation();
        if (currentToggleUrl) {
            form.action = currentToggleUrl;

            const nextInput = document.getElementById('hide-listing-next-url');
            if (nextInput){
                nextInput.value = window.location.href;
            }

            form.submit();  // sends POST with csrf + visibility=hide/show
        } else {
            closeModal();
        }
    });

    // Cancel button: just close
    cancelBtn.addEventListener('click', function (event) {
        event.stopPropagation();
        closeModal();
    });
});

</script>
<style>
/* Overlay container */
.hide-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    display: none;                 /* hidden by default */
    align-items: center;
    justify-content: center;
    z-index: 100;
}

/* When we add .show via JS, it appears */
.hide-modal-overlay.show {
    display: flex;
}

/* The white dialog card */
.hide-modal-card {
    background: #ffffff;
    border-radius: 18px;
    width: 320px;
    max-width: 90%;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    overflow: hidden;              /* so button bar matches radius */
    text-align: center;
}

/* Top warning icon */
.hide-modal-icon {
    margin-top: 18px;
    margin-bottom: 10px;
    font-size: 24px;
    color: #c0392b;
}

/* Main text */
.hide-modal-text {
    margin: 0 24px 18px 24px;
    font-family: "Lato", sans-serif;
    font-size: 15px;
    color: #111827;
    line-height: 1.4;
}

/* Button bar at bottom */
.hide-modal-actions {
    display: flex;
    height: 48px;
    border-top: 1px solid #e5e7eb;
}

.hide-modal-btn {
    flex: 1;
    border: none;
    background: transparent;
    color: #ffffff;
    font-family: "Lato", sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}

/* Left (confirm) â€“ blue */
.hide-modal-confirm {
    background: #1f73b7;
    border-right: 1px solid rgba(255, 255, 255, 0.5);
}

/* Right (cancel) â€“ red */
.hide-modal-cancel {
    background: #c0392b;
}

/* Hover effect */
.hide-modal-btn:hover {
    filter: brightness(0.95);
}
</style>

{% endblock %}


