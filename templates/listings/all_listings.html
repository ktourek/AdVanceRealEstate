{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container">
    <!-- Header with Add Listing Button -->
    {% if user.is_authenticated %}
    <div class="listings-header">
        <a href="{% url 'add_listing' %}" class="add-listing-btn">
            <i class="fas fa-plus" style="margin-right: 8px;"></i>Add Listing
        </a>
    </div>
    {% endif %}
    
    <!-- Sorting and Filtering Section -->
    <div class="sort-filter-section">
        <h2 class="sort-title">Sort listings by...</h2>
        <div class="filter-dropdowns">
            <select class="filter-dropdown" id="price-filter" name="price" onchange="applyFilters()">
                <option value="">Price Sort</option>
                <option value="low-high" {% if selected_price == 'low-high' %}selected{% endif %}>Low to High</option>
                <option value="high-low" {% if selected_price == 'high-low' %}selected{% endif %}>High to Low</option>
            </select>
            <select class="filter-dropdown" id="price-range-filter" name="price_range" onchange="applyFilters()">
                <option value="">Price Range</option>
                {% for pricebucket in pricebuckets %}
                <option value="{{ pricebucket.pk }}" {% if selected_price_range == pricebucket.pk %}selected{% endif %}>{{ pricebucket.range }}</option>
                {% endfor %}
            </select>
            <select class="filter-dropdown" id="neighborhood-filter" name="neighborhood" onchange="applyFilters()">
                <option value="">Neighborhood</option>
                {% for neighborhood in neighborhoods %}
                <option value="{{ neighborhood.pk }}" {% if selected_neighborhood == neighborhood.pk %}selected{% endif %}>{{ neighborhood.name }}</option>
                {% endfor %}
            </select>
            <select class="filter-dropdown" id="type-filter" name="type" onchange="applyFilters()">
                <option value="">Type</option>
                {% for prop_type in property_types %}
                <option value="{{ prop_type.pk }}" {% if selected_type == prop_type.pk %}selected{% endif %}>{{ prop_type.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Listings Container (updated via AJAX) -->
    <div id="listings-container">
        {% include 'listings/listing_fragment.html' %}
    </div>
    
    <!-- Pagination Container (updated via AJAX) -->
    <div id="pagination-container">
        {% include 'listings/pagination_fragment.html' %}
    </div>
</div>

<script>
// Apply filters using AJAX (no page reload)
function applyFilters() {
    const priceFilter = document.getElementById('price-filter');
    const priceRangeFilter = document.getElementById('price-range-filter');
    const neighborhoodFilter = document.getElementById('neighborhood-filter');
    const typeFilter = document.getElementById('type-filter');
    
    const params = new URLSearchParams();
    
    // Build query parameters
    if (priceFilter.value) {
        params.append('price', priceFilter.value);
    }
    if (priceRangeFilter.value) {
        params.append('price_range', priceRangeFilter.value);
    }
    if (neighborhoodFilter.value) {
        params.append('neighborhood', neighborhoodFilter.value);
    }
    if (typeFilter.value) {
        params.append('type', typeFilter.value);
    }
    
    // Update URL without reloading page (without ajax parameter)
    const queryString = params.toString();
    const displayUrl = '{% url "listings" %}' + (queryString ? '?' + queryString : '');
    window.history.pushState({}, '', displayUrl);
    
    // Add AJAX parameter for fetch request only
    params.append('ajax', '1');
    const paramString = params.toString();
    const baseUrl = '{% url "listings" %}';
    const fetchUrl = baseUrl + (paramString ? '?' + paramString : '');
    
    // Debug: log the fetch URL
    console.log('Base URL:', baseUrl);
    console.log('Parameters:', paramString);
    console.log('Full Fetch URL:', fetchUrl);
    console.log('AJAX parameter present:', paramString.includes('ajax=1'));
    
    // Show loading state
    const listingsContainer = document.getElementById('listings-container');
    const paginationContainer = document.getElementById('pagination-container');
    listingsContainer.innerHTML = '<div class="no-listings"><p>Loading...</p></div>';
    paginationContainer.innerHTML = '';
    
    // Fetch filtered results via AJAX
    fetch(fetchUrl, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            // If not JSON, try to get text to see what we got
            return response.text().then(text => {
                console.error('Expected JSON but got:', contentType, text.substring(0, 200));
                throw new Error('Server returned HTML instead of JSON. Check if AJAX detection is working.');
            });
        }
        return response.json();
    })
    .then(data => {
        // Check for error in response
        if (data.error) {
            console.error('Server error:', data.error);
            listingsContainer.innerHTML = '<div class="no-listings"><p>Error loading listings. Please refresh the page.</p></div>';
            return;
        }
        
        // Update listings container
        listingsContainer.innerHTML = data.listings_html;
        
        // Update pagination container (links will use normal navigation)
        paginationContainer.innerHTML = data.pagination_html;
        
        // Scroll to top of listings
        listingsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    })
    .catch(error => {
        console.error('Error fetching listings:', error);
        listingsContainer.innerHTML = '<div class="no-listings"><p>Error loading listings. Please refresh the page.</p></div>';
    });
}

// Note: Pagination links use normal navigation (full page load) to keep behavior simple.
</script>
{% endblock %}


